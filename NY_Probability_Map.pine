// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© NY Probability Map - Top 25 Variants

//@version=5
indicator("NY Probability Map", overlay=true, max_boxes_count=500, max_labels_count=500)

// ============================================================================
// USER INPUTS
// ============================================================================

show_sessions = input.bool(true, "Show Session Boxes", group="Display")
show_london_levels = input.bool(true, "Show London Levels", group="Display")
show_prob_table = input.bool(true, "Show Probability Table", group="Display")
show_debug = input.bool(true, "Show Debug Info", group="Display")

asia_color = input.color(color.new(color.blue, 85), "Asia", group="Colors")
london_color = input.color(color.new(color.orange, 85), "London", group="Colors")
ny_color = input.color(color.new(color.green, 85), "NY", group="Colors")

asia_range_window = input.int(200, "Asia Range Window", minval=50, maxval=500, group="Analysis")

// ============================================================================
// TIME SESSIONS
// ============================================================================

is_asia = not na(time(timeframe.period, "2000-0000:1234567", "America/New_York"))
is_london = not na(time(timeframe.period, "0000-0500:12345", "America/New_York"))
is_transition = not na(time(timeframe.period, "0500-0830:12345", "America/New_York"))
is_ny = not na(time(timeframe.period, "0830-1100:12345", "America/New_York"))

// ============================================================================
// VARIANT DATABASE (TOP 25)
// ============================================================================

var int DB_SIZE = 25

var string[] db_variant = array.from("Expanded|High|Above|Above", "Normal|High|Above|Above", "Expanded|High|Within|Within", "Expanded|High|Within|Above", "Compressed|High|Above|Above",
     "Expanded|High|Within|Below", "Expanded|Low|Below|Below", "Expanded|Low|Within|Above", "Expanded|Low|Within|Below", "Normal|High|Within|Above",
     "Normal|Low|Below|Below", "Normal|Low|Within|Above", "Compressed|High|Within|Above", "Compressed|Both|Above|Above", "Normal|High|Within|Within",
     "Expanded|Low|Within|Within", "Normal|High|Above|Within", "Expanded|High|Above|Within", "Compressed|Low|Within|Below", "Normal|Low|Within|Below",
     "Compressed|Low|Below|Below", "Normal|High|Within|Below", "Compressed|High|Within|Below", "Expanded|Low|Below|Within", "Compressed|Both|Within|Below")

var int[] db_n = array.from(96, 80, 63, 62, 59, 59, 55, 52, 51, 49, 45, 44, 44, 44, 43, 43, 41, 39, 38, 36, 36, 36, 34, 34, 33)
var float[] db_p_high = array.from(94.79, 91.25, 49.21, 93.55, 89.83, 5.08, 5.45, 94.23, 13.73, 95.92, 2.22, 90.91, 97.73, 95.45, 39.53, 41.86, 46.34, 58.97, 10.53, 2.78, 5.56, 16.67, 0.00, 38.24, 0.00)
var float[] db_p_fail = array.from(22.92, 25.00, 46.03, 33.87, 38.98, 35.59, 21.82, 26.92, 43.14, 34.69, 33.33, 34.09, 43.18, 25.00, 34.88, 30.23, 31.71, 25.64, 26.32, 36.11, 27.78, 36.11, 44.12, 17.65, 36.36)
var float[] db_pen_high = array.from(13.85, 12.00, 9.15, 12.65, 10.65, 19.05, 5.20, 14.65, 11.10, 18.55, 2.35, 11.03, 11.38, 29.20, 12.80, 15.02, 14.05, 8.15, 32.28, 91.85, 4.60, 7.15, nan, 21.65, nan)
var float[] db_pen_low = array.from(12.90, 8.70, 7.10, 6.88, 6.57, 18.95, 19.23, 18.60, 19.23, 5.43, 26.55, 18.45, 3.40, 130.72, 7.37, 23.05, 8.35, 15.10, 21.85, 21.02, 20.80, 12.17, 12.80, 21.10, 22.40)

// ============================================================================
// STATE VARIABLES
// ============================================================================

var float asia_h = na
var float asia_l = na
var float asia_r = na
var float london_h = na
var float london_l = na
var float london_m = na
var float london_r = na
var float trans_open = na
var float ny_open = na
var string current_variant = ""
var int variant_idx = -1
var float[] asia_history = array.new_float()

var bool asia_started = false
var bool london_started = false
var bool ny_started = false

var string debug_msg = ""

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

f_asia_regime(range_val) =>
    result = "Normal"
    if array.size(asia_history) >= 50
        sorted = array.copy(asia_history)
        array.sort(sorted)
        size = array.size(sorted)
        q33 = array.get(sorted, math.floor(size * 0.33))
        q66 = array.get(sorted, math.floor(size * 0.66))
        result := range_val < q33 ? "Compressed" : range_val > q66 ? "Expanded" : "Normal"
    result

f_london_sweep(lh, ll, ah, al) =>
    swept_h = lh > ah
    swept_l = ll < al
    swept_h and swept_l ? "Both" : swept_h ? "High" : swept_l ? "Low" : "None"

f_open_vs_london(open_price, lm, lr) =>
    tol = lr * 0.25
    open_price > lm + tol ? "Above" : open_price < lm - tol ? "Below" : "Within"

f_find_variant(var_str) =>
    idx = -1
    for i = 0 to DB_SIZE - 1
        if array.get(db_variant, i) == var_str
            idx := i
            break
    idx

// ============================================================================
// SESSION TRACKING
// ============================================================================

new_day = ta.change(dayofweek)

if new_day
    asia_h := na
    asia_l := na
    asia_r := na
    london_h := na
    london_l := na
    london_m := na
    london_r := na
    trans_open := na
    ny_open := na
    current_variant := ""
    variant_idx := -1
    asia_started := false
    london_started := false
    ny_started := false
    debug_msg := ""

// Track Asia
if is_asia
    asia_started := true
    asia_h := na(asia_h) ? high : math.max(asia_h, high)
    asia_l := na(asia_l) ? low : math.min(asia_l, low)

if not is_asia and asia_started and na(asia_r)
    asia_r := asia_h - asia_l
    if not na(asia_r) and asia_r > 0
        array.push(asia_history, asia_r)
        if array.size(asia_history) > asia_range_window
            array.shift(asia_history)

// Track London
if is_london
    london_started := true
    london_h := na(london_h) ? high : math.max(london_h, high)
    london_l := na(london_l) ? low : math.min(london_l, low)

if not is_london and london_started and na(london_m)
    if not na(london_h) and not na(london_l)
        london_m := (london_h + london_l) / 2
        london_r := london_h - london_l

// Capture Transition open
if is_transition and not is_transition[1] and na(trans_open)
    trans_open := open

// NY open - calculate variant
if is_ny and not is_ny[1] and na(ny_open)
    ny_started := true
    ny_open := open

    debug_msg := "NY START:\n"
    debug_msg := debug_msg + "Asia: " + (na(asia_r) ? "MISSING" : str.tostring(asia_r, "#.#")) + "\n"
    debug_msg := debug_msg + "London H: " + (na(london_h) ? "MISSING" : str.tostring(london_h)) + "\n"
    debug_msg := debug_msg + "London L: " + (na(london_l) ? "MISSING" : str.tostring(london_l)) + "\n"
    debug_msg := debug_msg + "London M: " + (na(london_m) ? "MISSING" : str.tostring(london_m)) + "\n"
    debug_msg := debug_msg + "Trans Open: " + (na(trans_open) ? "MISSING" : str.tostring(trans_open)) + "\n"
    debug_msg := debug_msg + "Asia Hist: " + str.tostring(array.size(asia_history)) + " days\n"

    if not na(asia_r) and not na(london_h) and not na(london_l) and not na(london_m) and not na(trans_open) and not na(asia_h) and not na(asia_l) and london_r > 0

        asia_regime = f_asia_regime(asia_r)
        london_sweep = f_london_sweep(london_h, london_l, asia_h, asia_l)
        trans_vs_london = f_open_vs_london(trans_open, london_m, london_r)
        ny_vs_london = f_open_vs_london(ny_open, london_m, london_r)

        current_variant := asia_regime + "|" + london_sweep + "|" + trans_vs_london + "|" + ny_vs_london
        variant_idx := f_find_variant(current_variant)

        debug_msg := debug_msg + "\nVariant: " + current_variant + "\n"
        debug_msg := debug_msg + "Found: " + (variant_idx >= 0 ? "YES (idx=" + str.tostring(variant_idx) + ")" : "NO - Not in Top 25")
    else
        debug_msg := debug_msg + "\nERROR: Missing required data!"

// ============================================================================
// VISUALIZATION - FIXED LINES USING PLOT
// ============================================================================

// Use plot instead of line.new - this creates FIXED horizontal lines at price levels
// These lines will NOT move when you scroll the chart
plot(is_ny and not na(london_h) ? london_h : na, "London High",
     color=color.red, linewidth=2, style=plot.style_line, trackprice=false)

plot(is_ny and not na(london_l) ? london_l : na, "London Low",
     color=color.green, linewidth=2, style=plot.style_line, trackprice=false)

// Background colors for sessions
bgcolor(is_asia ? color.new(color.blue, 95) : na, title="Asia Session")
bgcolor(is_london ? color.new(color.orange, 95) : na, title="London Session")
bgcolor(is_ny ? color.new(color.green, 95) : na, title="NY Session")

// Debug label at NY open
if show_debug and is_ny and not is_ny[1]
    label.new(bar_index, high, debug_msg,
              style=label.style_label_down,
              color=color.blue,
              textcolor=color.white,
              size=size.small,
              textalign=text.align_left)

// ============================================================================
// PROBABILITY TABLE
// ============================================================================

var table info_table = table.new(position.top_right, 2, 10, border_width=1)

if show_prob_table and is_ny
    if variant_idx >= 0
        n = array.get(db_n, variant_idx)
        p_high = array.get(db_p_high, variant_idx)
        p_low = 100.0 - p_high
        p_fail = array.get(db_p_fail, variant_idx)
        pen_h = array.get(db_pen_high, variant_idx)
        pen_l = array.get(db_pen_low, variant_idx)

        reliability = n >= 150 ? "High" : n >= 50 ? "Medium" : "Low"
        rel_color = n >= 150 ? color.green : n >= 50 ? color.orange : color.red

        table.cell(info_table, 0, 0, "NY PROBABILITY MAP", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.normal)
        table.merge_cells(info_table, 0, 0, 1, 0)

        table.cell(info_table, 0, 1, "P(High First):", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 1, str.tostring(p_high, "#.#") + "%", bgcolor=color.new(color.red, 80), text_color=color.white, text_size=size.large)

        table.cell(info_table, 0, 2, "P(Low First):", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 2, str.tostring(p_low, "#.#") + "%", bgcolor=color.new(color.green, 80), text_color=color.white, text_size=size.large)

        table.cell(info_table, 0, 3, "P(Fail):", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 3, str.tostring(p_fail, "#.#") + "%", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)

        table.cell(info_table, 0, 4, "Penetration:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 4, str.tostring(p_high > 50 ? pen_h : pen_l, "#.#") + " pts", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)

        table.cell(info_table, 0, 5, "Sample Size:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 5, str.tostring(n), bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)

        table.cell(info_table, 0, 6, "Reliability:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 6, reliability, bgcolor=color.new(color.gray, 90), text_color=rel_color, text_size=size.small)

        table.cell(info_table, 0, 7, "London High:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 7, str.tostring(london_h, format.mintick), bgcolor=color.new(color.red, 90), text_color=color.white, text_size=size.small)

        table.cell(info_table, 0, 8, "London Low:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 8, str.tostring(london_l, format.mintick), bgcolor=color.new(color.green, 90), text_color=color.white, text_size=size.small)

        table.cell(info_table, 0, 9, "Variant:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
        table.cell(info_table, 1, 9, current_variant, bgcolor=color.new(color.gray, 90), text_color=color.yellow, text_size=size.tiny)

    else
        table.clear(info_table, 0, 0, 1, 9)
        table.cell(info_table, 0, 0, "DEBUG INFO", bgcolor=color.new(color.red, 70), text_color=color.white, text_size=size.normal)
        table.merge_cells(info_table, 0, 0, 1, 0)

        if current_variant != ""
            table.cell(info_table, 0, 1, "Status:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
            table.cell(info_table, 1, 1, "Variant Not in Top 25", bgcolor=color.new(color.orange, 90), text_color=color.white, text_size=size.small)

            table.cell(info_table, 0, 2, "Variant:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
            table.cell(info_table, 1, 2, current_variant, bgcolor=color.new(color.gray, 90), text_color=color.yellow, text_size=size.tiny)

            table.cell(info_table, 0, 3, "Note:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
            table.cell(info_table, 1, 3, "This setup has <34 samples", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
        else
            table.cell(info_table, 0, 1, "Status:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
            table.cell(info_table, 1, 1, "Missing Data", bgcolor=color.new(color.red, 90), text_color=color.white, text_size=size.small)

            table.cell(info_table, 0, 2, "Check:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
            table.cell(info_table, 1, 2, "See blue label below", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)

else if not is_ny and show_prob_table
    table.clear(info_table, 0, 0, 1, 9)
    table.cell(info_table, 0, 0, "Waiting for NY Session (08:30 ET)...", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
    table.merge_cells(info_table, 0, 0, 1, 0)
