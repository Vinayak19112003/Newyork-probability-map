// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© NY Probability Map - Top 25 Variants

//@version=5
indicator("NY Probability Map", overlay=true, max_boxes_count=500, max_labels_count=500)

// ============================================================================
// USER INPUTS
// ============================================================================

show_sessions = input.bool(true, "Show Session Boxes", group="Display")
show_london_levels = input.bool(true, "Show London Levels", group="Display")
show_prob_table = input.bool(true, "Show Probability Table", group="Display")

asia_color = input.color(color.new(color.blue, 90), "Asia", group="Colors")
london_color = input.color(color.new(color.orange, 90), "London", group="Colors")
ny_color = input.color(color.new(color.green, 90), "NY", group="Colors")

asia_range_window = input.int(200, "Asia Range Window", minval=50, maxval=500, group="Analysis")

// ============================================================================
// TIME SESSIONS
// ============================================================================

is_asia = not na(time(timeframe.period, "2000-0000:23456"))
is_london = not na(time(timeframe.period, "0200-0500:12345"))
is_ny = not na(time(timeframe.period, "0830-1100:12345"))

// ============================================================================
// VARIANT DATABASE (TOP 25 BY SAMPLE SIZE)
// ============================================================================

// Variant count: 25
var int DB_SIZE = 25

// Database arrays
var string[] db_variant = array.from("Expanded|High|Above|Above", "Expanded|High|Within|Below", "Normal|High|Above|Above", "Expanded|High|Within|Above", "Compressed|High|Above|Above",
     "Normal|High|Within|Above", "Expanded|Low|Within|Above", "Expanded|High|Within|Within", "Expanded|Low|Below|Below", "Compressed|High|Within|Above",
     "Normal|Low|Within|Above", "Expanded|Low|Within|Within", "Compressed|High|Within|Below", "Normal|High|Within|Within", "Normal|Low|Below|Below",
     "Expanded|Low|Within|Below", "Normal|Low|Within|Below", "Compressed|Low|Within|Below", "Normal|High|Within|Below", "Expanded|High|Above|Within",
     "Compressed|Low|Within|Above", "Expanded|None|Within|Above", "Expanded|High|Above|Below", "Normal|High|Above|Within", "Normal|High|Below|Below")

var int[] db_n = array.from(85, 66, 66, 63, 62, 62, 58, 57, 56, 51, 47, 46, 45, 43, 42, 41, 41, 41, 41, 38, 36, 36, 35, 34, 34)

var float[] db_p_high = array.from(92.94, 4.55, 92.42, 95.24, 93.55, 95.16, 94.83, 52.63, 5.36, 94.12, 91.49, 43.48, 2.22, 48.84, 2.38, 9.76, 7.32, 4.88, 9.76, 63.16, 91.67, 94.44, 5.71, 44.12, 5.88)

var float[] db_p_fail = array.from(34.12, 42.42, 31.82, 36.51, 37.10, 45.16, 29.31, 52.63, 23.21, 45.10, 38.30, 36.96, 46.67, 34.88, 38.10, 53.66, 36.59, 29.27, 29.27, 31.58, 58.33, 50.00, 31.43, 41.18, 44.12)

var float[] db_pen_high = array.from(12.00, 10.65, 11.90, 13.85, 12.25, 18.75, 19.70, 8.20, 6.20, 15.98, 9.25, 15.75, 52.70, 17.05, 4.30, 10.90, 1.20, 63.25, 6.77, 10.70, 17.65, 21.47, 40.42, 11.35, 15.15)

var float[] db_pen_low = array.from(14.70, 21.35, 5.85, 9.10, 4.82, 9.90, 18.60, 8.65, 23.10, 9.40, 20.32, 16.17, 13.45, 11.90, 23.40, 21.85, 20.65, 23.80, 16.25, 10.13, 8.30, 8.38, 10.05, 5.65, 11.73)

// ============================================================================
// STATE VARIABLES
// ============================================================================

var float asia_h = na
var float asia_l = na
var float asia_r = na

var float london_h = na
var float london_l = na
var float london_m = na
var float london_r = na

var float trans_open = na
var float ny_open = na

var string current_variant = ""
var int variant_idx = -1

var float[] asia_history = array.new_float()

// Visual elements
var box asia_box = na
var box london_box = na
var box ny_box = na
var line london_h_line = na
var line london_l_line = na
var table info_table = na

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Get Asia regime
f_asia_regime(range_val) =>
    result = "Normal"
    if array.size(asia_history) >= 50
        sorted = array.copy(asia_history)
        array.sort(sorted)
        size = array.size(sorted)
        idx33 = math.floor(size * 0.33)
        idx66 = math.floor(size * 0.66)
        q33 = array.get(sorted, idx33)
        q66 = array.get(sorted, idx66)
        result := range_val < q33 ? "Compressed" : range_val > q66 ? "Expanded" : "Normal"
    result

// Get London sweep
f_london_sweep(lh, ll, ah, al) =>
    swept_h = lh > ah
    swept_l = ll < al
    swept_h and swept_l ? "Both" : swept_h ? "High" : swept_l ? "Low" : "None"

// Get open vs London mid
f_open_vs_london(open_price, lm, lr) =>
    tol = lr * 0.25
    upper = lm + tol
    lower = lm - tol
    open_price > upper ? "Above" : open_price < lower ? "Below" : "Within"

// Find variant
f_find_variant(var_str) =>
    idx = -1
    for i = 0 to DB_SIZE - 1
        if array.get(db_variant, i) == var_str
            idx := i
            break
    idx

// ============================================================================
// MAIN LOGIC
// ============================================================================

// New day detection
new_day = ta.change(time("D"))

// Reset on new day
if new_day
    asia_h := na
    asia_l := na
    asia_r := na
    london_h := na
    london_l := na
    london_m := na
    london_r := na
    trans_open := na
    ny_open := na
    current_variant := ""
    variant_idx := -1

// Track Asia
if is_asia
    asia_h := na(asia_h) ? high : math.max(asia_h, high)
    asia_l := na(asia_l) ? low : math.min(asia_l, low)

// End of Asia
if is_asia[1] and not is_asia
    asia_r := asia_h - asia_l
    if not na(asia_r)
        array.push(asia_history, asia_r)
        if array.size(asia_history) > asia_range_window
            array.shift(asia_history)

// Track London
if is_london
    london_h := na(london_h) ? high : math.max(london_h, high)
    london_l := na(london_l) ? low : math.min(london_l, low)

// End of London
if is_london[1] and not is_london
    if not na(london_h) and not na(london_l)
        london_m := (london_h + london_l) / 2
        london_r := london_h - london_l

// Capture Transition open
if not na(time(timeframe.period, "0500-0501:12345")) and na(trans_open)
    trans_open := open

// NY open - calculate variant
if is_ny and na(is_ny[1]) and na(ny_open)
    ny_open := open

    // Calculate variant if all data available
    if not na(asia_r) and not na(london_h) and not na(london_l) and not na(london_m) and not na(trans_open) and not na(asia_h) and not na(asia_l)

        asia_regime = f_asia_regime(asia_r)
        london_sweep = f_london_sweep(london_h, london_l, asia_h, asia_l)
        trans_vs_london = f_open_vs_london(trans_open, london_m, london_r)
        ny_vs_london = f_open_vs_london(ny_open, london_m, london_r)

        current_variant := asia_regime + "|" + london_sweep + "|" + trans_vs_london + "|" + ny_vs_london
        variant_idx := f_find_variant(current_variant)

// ============================================================================
// VISUALIZATION
// ============================================================================

// Session boxes
if show_sessions
    // Asia
    if is_asia and na(is_asia[1])
        asia_box := box.new(bar_index, high, bar_index, low, bgcolor=asia_color, border_color=na)
    if not na(asia_box) and is_asia
        box.set_right(asia_box, bar_index)
        box.set_top(asia_box, math.max(box.get_top(asia_box), high))
        box.set_bottom(asia_box, math.min(box.get_bottom(asia_box), low))

    // London
    if is_london and na(is_london[1])
        london_box := box.new(bar_index, high, bar_index, low, bgcolor=london_color, border_color=na)
    if not na(london_box) and is_london
        box.set_right(london_box, bar_index)
        box.set_top(london_box, math.max(box.get_top(london_box), high))
        box.set_bottom(london_box, math.min(box.get_bottom(london_box), low))

    // NY
    if is_ny and na(is_ny[1])
        ny_box := box.new(bar_index, high, bar_index, low, bgcolor=ny_color, border_color=na)
    if not na(ny_box) and is_ny
        box.set_right(ny_box, bar_index)
        box.set_top(ny_box, math.max(box.get_top(ny_box), high))
        box.set_bottom(ny_box, math.min(box.get_bottom(ny_box), low))

// London levels
if show_london_levels and is_ny and not na(london_h) and not na(london_l)
    if na(london_h_line) or (na(is_ny[1]) and is_ny)
        london_h_line := line.new(bar_index, london_h, bar_index, london_h, color=color.red, width=2, style=line.style_dashed)
        london_l_line := line.new(bar_index, london_l, bar_index, london_l, color=color.green, width=2, style=line.style_dashed)
    else
        line.set_x2(london_h_line, bar_index)
        line.set_x2(london_l_line, bar_index)

// Probability table
if show_prob_table
    if na(info_table)
        info_table := table.new(position.top_right, 2, 8, border_width=1)

    if is_ny and variant_idx >= 0
        n = array.get(db_n, variant_idx)
        p_high = array.get(db_p_high, variant_idx)
        p_low = 100.0 - p_high
        p_fail = array.get(db_p_fail, variant_idx)
        pen_h = array.get(db_pen_high, variant_idx)
        pen_l = array.get(db_pen_low, variant_idx)

        reliability = n >= 150 ? "High" : n >= 50 ? "Medium" : "Low"
        rel_color = n >= 150 ? color.green : n >= 50 ? color.orange : color.red

        table.cell(info_table, 0, 0, "NY PROBABILITY MAP", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.merge_cells(info_table, 0, 0, 1, 0)

        table.cell(info_table, 0, 1, "P(High First):", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 1, str.tostring(p_high, "#.#") + "%", bgcolor=color.new(color.red, 80), text_color=color.white, text_size=size.large)

        table.cell(info_table, 0, 2, "P(Low First):", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 2, str.tostring(p_low, "#.#") + "%", bgcolor=color.new(color.green, 80), text_color=color.white, text_size=size.large)

        table.cell(info_table, 0, 3, "P(Fail):", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 3, str.tostring(p_fail, "#.#") + "%", bgcolor=color.new(color.gray, 90), text_color=color.white)

        table.cell(info_table, 0, 4, "Penetration:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 4, str.tostring(p_high > 50 ? pen_h : pen_l, "#.#") + " pts", bgcolor=color.new(color.gray, 90), text_color=color.white)

        table.cell(info_table, 0, 5, "Sample Size:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 5, str.tostring(n), bgcolor=color.new(color.gray, 90), text_color=color.white)

        table.cell(info_table, 0, 6, "Reliability:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.small)
        table.cell(info_table, 1, 6, reliability, bgcolor=color.new(color.gray, 90), text_color=rel_color)

        table.cell(info_table, 0, 7, "Variant:", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
        table.cell(info_table, 1, 7, current_variant, bgcolor=color.new(color.gray, 90), text_color=color.yellow, text_size=size.tiny)

    else if not is_ny
        table.clear(info_table, 0, 0, 1, 7)

// Plot London levels for reference
plot(is_ny and not na(london_h) ? london_h : na, "London High", color=color.new(color.red, 80), linewidth=1, style=plot.style_circles)
plot(is_ny and not na(london_l) ? london_l : na, "London Low", color=color.new(color.green, 80), linewidth=1, style=plot.style_circles)
